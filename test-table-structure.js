/**
 * Script de test pour valider la structure du tableau des donn√©es d√©taill√©es
 * 
 * FONCTIONNALIT√âS TEST√âES :
 * 1. Colonnes dans l'ordre sp√©cifi√©
 * 2. Masquage des objectifs dans les en-t√™tes
 * 3. Calcul du taux d'encaissement
 * 4. Affichage des r√©alisations uniquement
 */

const express = require('express');

// Configuration de test
const TEST_CONFIG = {
  baseUrl: 'http://localhost:3001', // URL du backend
  testAgenceId: 1, // ID d'agence de test
  testStartDate: '2024-12-01', // Date de d√©but de test
  testEndDate: '2024-12-07' // Date de fin de test
};

/**
 * Fonction pour tester la structure du tableau
 */
async function testTableStructure() {
  console.log('üß™ Test de la structure du tableau des donn√©es d√©taill√©es');
  console.log('=====================================================');
  console.log(`üìä Agence ID: ${TEST_CONFIG.testAgenceId}`);
  console.log(`üìÖ P√©riode: ${TEST_CONFIG.testStartDate} au ${TEST_CONFIG.testEndDate}`);
  console.log('');
  
  try {
    // Appel √† l'endpoint detailed-data
    const response = await fetch(
      `${TEST_CONFIG.baseUrl}/api/kpi/detailed-data?agenceId=${TEST_CONFIG.testAgenceId}&startDate=${TEST_CONFIG.testStartDate}&endDate=${TEST_CONFIG.testEndDate}`
    );
    
    if (!response.ok) {
      throw new Error(`Erreur HTTP: ${response.status} - ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('üìä Donn√©es re√ßues:', JSON.stringify(data, null, 2));
    
    // Validation de la structure des colonnes
    console.log('\nüîç VALIDATION DE LA STRUCTURE DES COLONNES:');
    console.log('==========================================');
    
    if (data.data && data.data.length > 0) {
      const firstRecord = data.data[0];
      
      // V√©rifier la pr√©sence des champs requis
      const requiredFields = [
        'DateKPI',
        'Nb_RelancesEnvoyees', 'Mt_RelancesEnvoyees',
        'Nb_RelancesReglees', 'Mt_RelancesReglees',
        'Nb_MisesEnDemeure_Envoyees', 'Mt_MisesEnDemeure_Envoyees',
        'Nb_MisesEnDemeure_Reglees', 'Mt_MisesEnDemeure_Reglees',
        'Nb_Dossiers_Juridiques', 'Mt_Dossiers_Juridiques',
        'Nb_Coupures', 'Mt_Coupures',
        'Nb_Retablissements', 'Mt_Retablissements',
        'Nb_Compteurs_Remplaces',
        'Encaissement_Journalier_Global',
        'Obj_Encaissement' // Pour le calcul du taux
      ];
      
      console.log('üìã Champs requis pr√©sents:');
      requiredFields.forEach(field => {
        const hasField = firstRecord.hasOwnProperty(field);
        const value = firstRecord[field];
        console.log(`${field}: ${hasField ? '‚úÖ' : '‚ùå'} (${value || 0})`);
      });
      
      // Validation du calcul du taux d'encaissement
      console.log('\nüìä VALIDATION DU CALCUL DU TAUX D\'ENCAISSEMENT:');
      console.log('==============================================');
      
      const encaissementRealise = firstRecord.Encaissement_Journalier_Global || 0;
      const encaissementObjectif = firstRecord.Obj_Encaissement || 0;
      const tauxCalcule = encaissementObjectif > 0 ? 
        Math.round((encaissementRealise / encaissementObjectif) * 100) : 0;
      
      console.log(`Encaissement r√©alis√©: ${encaissementRealise} DA`);
      console.log(`Encaissement objectif: ${encaissementObjectif} DA`);
      console.log(`Taux calcul√©: ${tauxCalcule}%`);
      
      if (encaissementObjectif > 0) {
        console.log(`Calcul correct: ${tauxCalcule >= 0 && tauxCalcule <= 100 ? '‚úÖ' : '‚ùå'}`);
      } else {
        console.log('Pas d\'objectif d√©fini ‚Üí Taux = 0%');
      }
      
      // Exemple d'affichage des colonnes
      console.log('\nüìã EXEMPLE D\'AFFICHAGE DES COLONNES:');
      console.log('------------------------------------');
      console.log(`Date: ${firstRecord.DateKPI}`);
      console.log('');
      console.log('Colonnes du tableau:');
      console.log('1. Date');
      console.log('2. Relances Envoy√©es');
      console.log('3. Relances Encaiss√©es');
      console.log('4. Mises en Demeure');
      console.log('5. Mises en Demeure Encaiss√©es');
      console.log('6. Dossiers Juridiques');
      console.log('7. Coupures');
      console.log('8. R√©tablissements');
      console.log('9. Compteurs');
      console.log('10. Encaissement Global');
      console.log('11. Taux Encaissement (%)');
      
      // Validation des donn√©es d'exemple
      console.log('\nüìä DONN√âES D\'EXEMPLE:');
      console.log('----------------------');
      console.log(`Relances Envoy√©es: ${firstRecord.Nb_RelancesEnvoyees || 0} (${firstRecord.Mt_RelancesEnvoyees || 0} DA)`);
      console.log(`Relances Encaiss√©es: ${firstRecord.Nb_RelancesReglees || 0} (${firstRecord.Mt_RelancesReglees || 0} DA)`);
      console.log(`Mises en Demeure: ${firstRecord.Nb_MisesEnDemeure_Envoyees || 0} (${firstRecord.Mt_MisesEnDemeure_Envoyees || 0} DA)`);
      console.log(`Mises en Demeure Encaiss√©es: ${firstRecord.Nb_MisesEnDemeure_Reglees || 0} (${firstRecord.Mt_MisesEnDemeure_Reglees || 0} DA)`);
      console.log(`Dossiers Juridiques: ${firstRecord.Nb_Dossiers_Juridiques || 0} (${firstRecord.Mt_Dossiers_Juridiques || 0} DA)`);
      console.log(`Coupures: ${firstRecord.Nb_Coupures || 0} (${firstRecord.Mt_Coupures || 0} DA)`);
      console.log(`R√©tablissements: ${firstRecord.Nb_Retablissements || 0} (${firstRecord.Mt_Retablissements || 0} DA)`);
      console.log(`Compteurs: ${firstRecord.Nb_Compteurs_Remplaces || 0}`);
      console.log(`Encaissement Global: ${firstRecord.Encaissement_Journalier_Global || 0} DA`);
      console.log(`Taux Encaissement: ${tauxCalcule}%`);
      
    } else {
      console.log('\n‚ö†Ô∏è Aucune donn√©e trouv√©e pour cette p√©riode');
      console.log('   ‚Üí V√©rifiez que l\'agence a des donn√©es pour cette p√©riode');
    }
    
    console.log('\n‚úÖ Test de la structure du tableau termin√© avec succ√®s');
    
  } catch (error) {
    console.error('‚ùå Erreur lors du test:', error.message);
    console.error('Stack trace:', error.stack);
  }
}

/**
 * Fonction pour valider l'ordre des colonnes
 */
function validateColumnOrder() {
  console.log('\nüß™ VALIDATION DE L\'ORDRE DES COLONNES');
  console.log('=====================================');
  
  const expectedColumns = [
    'Date',
    'Relances Envoy√©es',
    'Relances Encaiss√©es',
    'Mises en Demeure',
    'Mises en Demeure Encaiss√©es',
    'Dossiers Juridiques',
    'Coupures',
    'R√©tablissements',
    'Compteurs',
    'Encaissement Global',
    'Taux Encaissement (%)'
  ];
  
  console.log('üìã Ordre des colonnes attendu:');
  expectedColumns.forEach((column, index) => {
    console.log(`${index + 1}. ${column}`);
  });
  
  console.log('\n‚úÖ Ordre des colonnes valid√©');
  console.log('   ‚Üí Colonnes dans l\'ordre sp√©cifi√©');
  console.log('   ‚Üí En-t√™tes sans objectifs');
  console.log('   ‚Üí Taux d\'encaissement calcul√©');
}

/**
 * Fonction pour valider le masquage des objectifs
 */
function validateObjectiveMasking() {
  console.log('\nüß™ VALIDATION DU MASQUAGE DES OBJECTIFS');
  console.log('======================================');
  
  console.log('üìã R√®gles de masquage des objectifs:');
  console.log('1. ‚úÖ En-t√™tes sans valeurs d\'objectifs');
  console.log('2. ‚úÖ Seuls les noms des indicateurs visibles');
  console.log('3. ‚úÖ Pas de texte "Objectif: XXX" dans les en-t√™tes');
  console.log('4. ‚úÖ Objectifs utilis√©s uniquement pour les calculs internes');
  
  console.log('\nüìä Exemples d\'en-t√™tes corrects:');
  console.log('- "Relances Envoy√©es" ‚úÖ');
  console.log('- "Mises en Demeure" ‚úÖ');
  console.log('- "Encaissement Global" ‚úÖ');
  console.log('- "Taux Encaissement (%)" ‚úÖ');
  
  console.log('\n‚ùå Exemples d\'en-t√™tes √† √©viter:');
  console.log('- "Objectif: 400 000,00 DA" ‚ùå');
  console.log('- "Objectif: 73" ‚ùå');
  console.log('- "Relances (Objectif: 50)" ‚ùå');
  
  console.log('\n‚úÖ Masquage des objectifs valid√©');
  console.log('   ‚Üí En-t√™tes propres et clairs');
  console.log('   ‚Üí Objectifs masqu√©s dans l\'interface');
  console.log('   ‚Üí Calculs internes pr√©serv√©s');
}

/**
 * Fonction pour tester le calcul du taux d'encaissement
 */
async function testEncashmentRateCalculation() {
  console.log('\nüß™ TEST DU CALCUL DU TAUX D\'ENCAISSEMENT');
  console.log('========================================');
  
  try {
    const response = await fetch(
      `${TEST_CONFIG.baseUrl}/api/kpi/detailed-data?agenceId=${TEST_CONFIG.testAgenceId}&startDate=${TEST_CONFIG.testStartDate}&endDate=${TEST_CONFIG.testEndDate}`
    );
    
    if (response.ok) {
      const data = await response.json();
      
      if (data.data && data.data.length > 0) {
        console.log('üìä Validation des calculs de taux:');
        
        data.data.forEach((record, index) => {
          const encaissementRealise = record.Encaissement_Journalier_Global || 0;
          const encaissementObjectif = record.Obj_Encaissement || 0;
          const tauxCalcule = encaissementObjectif > 0 ? 
            Math.round((encaissementRealise / encaissementObjectif) * 100) : 0;
          
          console.log(`\nDate ${index + 1}: ${record.DateKPI}`);
          console.log(`  Encaissement r√©alis√©: ${encaissementRealise} DA`);
          console.log(`  Encaissement objectif: ${encaissementObjectif} DA`);
          console.log(`  Taux calcul√©: ${tauxCalcule}%`);
          
          // Validation de la coh√©rence
          if (encaissementObjectif > 0) {
            const tauxAttendu = Math.round((encaissementRealise / encaissementObjectif) * 100);
            console.log(`  Calcul correct: ${tauxCalcule === tauxAttendu ? '‚úÖ' : '‚ùå'}`);
          } else {
            console.log(`  Pas d'objectif ‚Üí Taux = 0%: ${tauxCalcule === 0 ? '‚úÖ' : '‚ùå'}`);
          }
        });
        
        console.log('\n‚úÖ Test du calcul du taux d\'encaissement termin√©');
      } else {
        console.log('‚ö†Ô∏è Aucune donn√©e √† valider');
      }
    } else {
      console.log(`‚ùå Erreur: ${response.status} - ${response.statusText}`);
    }
  } catch (error) {
    console.log(`‚ùå Erreur: ${error.message}`);
  }
}

// Ex√©cution des tests
if (require.main === module) {
  (async () => {
    await testTableStructure();
    validateColumnOrder();
    validateObjectiveMasking();
    await testEncashmentRateCalculation();
  })();
}

module.exports = {
  testTableStructure,
  validateColumnOrder,
  validateObjectiveMasking,
  testEncashmentRateCalculation
};
